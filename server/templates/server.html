<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <title>ğŸ” KriptoServer</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
  <div class="container">
    <h1 class="title">ğŸ–¥ï¸ Kriptoloji Sunucu Paneli</h1>

    {% if not started %}
      <!-- ğŸŒ Server BaÅŸlatma -->
      <div class="form-card">
        <h3>ğŸŒ Server BaÅŸlat</h3>
        <form id="startServerForm" method="POST">
          <div class="field">
            <label>IP Adresi:</label>
            <input type="text" id="serverIP" name="ip" placeholder="Ã¶rn: 192.168.1.170" required>
          </div>
          <div class="field">
            <label>Port:</label>
            <input type="number" id="serverPort" name="port" placeholder="Ã¶rn: 6000" required>
          </div>
          <button type="submit" class="btn-send">ğŸš€ Server BaÅŸlat</button>
        </form>
      </div>
    {% else %}
      <div class="info-card">
        <p><strong>Server Ã§alÄ±ÅŸÄ±yor:</strong> {{ ip }} : {{ port }}</p>
      </div>

      <!-- ğŸ“¤ Clientâ€™a Mesaj GÃ¶nder -->
      <div class="form-card">
        <h3>ğŸ“¤ Clientâ€™a Mesaj GÃ¶nder</h3>
        <form id="sendForm">
          <div class="field">
            <label>Client IP:</label>
            <input type="text" name="ip" id="clientIP" placeholder="Ã¶rn: 192.168.1.189" required>
          </div>
          <div class="field">
            <label>Client Port:</label>
            <input type="number" name="port" id="clientPort" placeholder="Ã¶rn: 6001" required>
          </div>
          <div class="field">
            <label>Åifreleme TÃ¼rÃ¼:</label>
            <select name="algorithm" id="algorithmSelect">
              <option value="caesar">Sezar</option>
              <option value="vigenere">Vigenere</option>
              <option value="substitution">Substitution</option>
              <option value="affine">Affine</option>
            </select>
          </div>
          <div class="field">
            <input type="text" name="message" id="messageInput" placeholder="GÃ¶nderilecek mesaj..." required>
          </div>
          <button type="submit" class="btn-send">ğŸ“¡ GÃ¶nder</button>
        </form>
      </div>

      <!-- ğŸ•“ Mesaj GeÃ§miÅŸi -->
      <div class="history-section">
        <div class="history-header">
          <h3>ğŸ“¥ Mesaj GeÃ§miÅŸi</h3>
          <button id="clearBtn" class="btn-clear">ğŸ§¹ Temizle</button>
        </div>
        <div class="history-box" id="messageBox"></div>
      </div>
    {% endif %}
  </div>

  <script>
    // === Server BaÅŸlatma ===
    document.getElementById("startServerForm")?.addEventListener("submit", async (e) => {
      e.preventDefault();
      const form = document.getElementById("startServerForm");
      const data = new FormData(form);

      const res = await fetch("/start_server", { method: "POST", body: data });
      const result = await res.json();

      if (result.success) {
        alert("âœ… Server baÅŸarÄ±yla baÅŸlatÄ±ldÄ±!");
        location.reload();
      } else {
        alert("âŒ Server baÅŸlatÄ±lamadÄ±: " + (result.error || "Bilinmeyen hata"));
      }
    });

    // === Mesaj GÃ¶nder ===
    document.getElementById("sendForm")?.addEventListener("submit", async (e) => {
      e.preventDefault();
      const form = document.getElementById("sendForm");
      const data = new FormData(form);

      const res = await fetch("/send", { method: "POST", body: data });
      const result = await res.json();

      if (result.success) {
        alert("âœ… Mesaj ÅŸifrelenip gÃ¶nderildi!");
      } else {
        alert("âŒ GÃ¶nderim hatasÄ±! Client dinliyor mu kontrol edin.");
      }
    });

    // === Mesaj GeÃ§miÅŸi YÃ¼kleme ===
    async function loadMessages() {
      const res = await fetch("/messages");
      const data = await res.json();
      const box = document.getElementById("messageBox");
      if (!box) return;
      box.innerHTML = "";
      data.forEach(msg => {
        const div = document.createElement("div");
        div.classList.add("message");
        const dir = msg.direction === "Client â†’ Server" ? "ğŸŸ¢" : "ğŸ”µ";
        div.innerHTML = `
          <strong>${dir} ${msg.direction}</strong><br>
          <small>Algoritma:</small> ${msg.algorithm}<br>
          <small>Åifreli:</small> ${msg.encrypted}<br>
          <small>Ã‡Ã¶zÃ¼lmÃ¼ÅŸ:</small> <span class="dec">${msg.decrypted}</span>
        `;
        box.appendChild(div);
      });
      box.scrollTop = box.scrollHeight;
    }

    // === GeÃ§miÅŸi Temizle ===
    document.getElementById("clearBtn")?.addEventListener("click", async () => {
      await fetch("/clear", { method: "POST" });
      document.getElementById("messageBox").innerHTML = "";
    });

    setInterval(loadMessages, 2000);
    loadMessages();
  </script>
</body>
</html>