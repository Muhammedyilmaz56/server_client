<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <title>KriptoServer</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
</head>
<body>
  <div class="container">
    <h1 class="title">Kriptoloji Sunucu Paneli</h1>

    <div class="form-card">
      <h3>Server Başlat</h3>
      <div class="field">
        <label>IP Adresi:</label>
        <input type="text" id="serverIP" value="{{ ip or '' }}" placeholder="örn: 192.168.1.170">
      </div>
      <div class="field">
        <label>Port:</label>
        <input type="number" id="serverPort" value="{{ port or '6000' }}">
      </div>
      <button id="startBtn" class="btn-send">Server Başlat</button>
      <p id="statusText" style="color:green;font-weight:bold;margin-top:10px;"></p>
    </div>

    <div class="form-card">
      <h3>Client’a Mesaj Gönder</h3>
      <div class="field">
        <label>Client IP:</label>
        <input type="text" id="clientIP" placeholder="örn: 192.168.1.189">
      </div>
      <div class="field">
        <label>Client Port:</label>
        <input type="number" id="clientPort" value="6001">
      </div>
      <div class="field">
        <label>Şifreleme Türü:</label>
        <select id="algorithmSelect">
          <option value="caesar">Sezar</option>
          <option value="vigenere">Vigenere</option>
          <option value="substitution">Substitution</option>
          <option value="affine">Affine</option>
        </select>
      </div>

      <div class="field" id="keyField" style="display:none;">
        <label id="keyLabel">Anahtar:</label>
        <input type="text" id="keyInput" placeholder="örnek: 3 veya anahtar veya 5,8">
      </div>

      <div class="field">
        <input type="text" id="messageInput" placeholder="Gönderilecek mesaj...">
      </div>
      <button id="sendBtn" class="btn-send">Gönder</button>
    </div>

    <div class="response-card">
      <h3>Sohbet Geçmişi</h3>
      <div id="chatBox" class="chat-box"></div>
      <button id="clearBtn" class="btn-clear">Temizle</button>
    </div>
  </div>

  <div id="toast" class="toast"></div>

  <script>
    const socket = io();
    const toastBox = document.getElementById("toast");

    function showToast(text, type="success") {
      toastBox.textContent = text;
      toastBox.className = `toast ${type} show`;
      setTimeout(() => toastBox.classList.remove("show"), 3000);
    }

    socket.on("connect", () => console.log("SocketIO bağlı"));
    socket.on("message_history", (history) => {
      const box = document.getElementById("chatBox");
      box.innerHTML = "";
      history.forEach((m) => addMessage(m));
    });
    socket.on("new_message", (msg) => addMessage(msg));
    socket.on("messages_cleared", () => {
      document.getElementById("chatBox").innerHTML = "";
      showToast("Mesaj geçmişi temizlendi!");
    });

    function addMessage(m) {
      const box = document.getElementById("chatBox");
      const div = document.createElement("div");
      div.classList.add("chat-message");

      const time = new Date().toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'});

      if (m.direction === "Server → Client") div.classList.add("from-server");
      else div.classList.add("from-client");

      div.innerHTML = `
        <div class="meta">
          <b>${m.direction}</b> 
          <small>(${m.algorithm})</small> 
          <small>${time}</small>
        </div>
        <div class="bubble">
          <p><b>Şifreli:</b> ${m.encrypted}</p>
          <p><b>Çözülmüş:</b> ${m.decrypted}</p>
        </div>
      `;
      box.appendChild(div);
      box.scrollTop = box.scrollHeight;
    }

    const algoSelect = document.getElementById("algorithmSelect");
    const keyField = document.getElementById("keyField");
    const keyLabel = document.getElementById("keyLabel");
    algoSelect.addEventListener("change", () => {
      const algo = algoSelect.value;
      if (algo === "caesar") {
        keyField.style.display = "block";
        keyLabel.textContent = "Anahtar (örn: 3)";
      } else if (algo === "vigenere") {
        keyField.style.display = "block";
        keyLabel.textContent = "Anahtar (örn: anahtar)";
      } else if (algo === "affine") {
        keyField.style.display = "block";
        keyLabel.textContent = "a,b Değerleri (örn: 5,8)";
      } else {
        keyField.style.display = "none";
      }
    });

    document.getElementById("startBtn").onclick = async () => {
      const ip = document.getElementById("serverIP").value.trim();
      const port = document.getElementById("serverPort").value.trim();
      if (!ip || !port) return showToast("IP veya Port boş olamaz!", "error");
      const form = new FormData();
      form.append("ip", ip);
      form.append("port", port);
      const res = await fetch("/start_server", { method: "POST", body: form });
      const data = await res.json();
      const status = document.getElementById("statusText");
      if (data.success) {
        status.textContent = `Server aktif: ${data.ip}:${data.port}`;
        showToast("Server başarıyla başlatıldı!");
      } else {
        status.textContent = "Hata: " + (data.error || "Başlatılamadı");
        status.style.color = "red";
        showToast("Server başlatılamadı!", "error");
      }
    };

    document.getElementById("sendBtn").onclick = async () => {
      const ip = document.getElementById("clientIP").value.trim();
      const port = document.getElementById("clientPort").value.trim();
      const msg = document.getElementById("messageInput").value.trim();
      const algo = document.getElementById("algorithmSelect").value;
      const key = document.getElementById("keyInput").value.trim();
      if (!ip || !port || !msg) return showToast("Tüm alanları doldurun!", "error");

      const form = new FormData();
      form.append("ip", ip);
      form.append("port", port);
      form.append("message", msg);
      form.append("algorithm", algo);
      if (key) form.append("key", key);

      const res = await fetch("/send", { method: "POST", body: form });
      const data = await res.json();
      if (data.success) showToast("Mesaj gönderildi!");
      else showToast("Gönderim hatası: Client çevrimdışı olabilir.", "error");
    };

    document.getElementById("clearBtn").onclick = () => {
      socket.emit("clear_messages");
    };
  </script>
</body>
</html>
