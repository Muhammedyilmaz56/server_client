<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <title>ğŸ” KriptoClient</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
  <div class="container">
    <h1>ğŸ” Kriptoloji Client Paneli</h1>

    <!-- ğŸŒ IP & Port AyarlarÄ± -->
    <div class="form-card">
      <h3>ğŸŒ IP & Port AyarlarÄ±</h3>
      <div class="field">
        <label>IP Adresi:</label>
        <input type="text" id="configIP" value="{{ ip or '' }}" placeholder="Ã¶rn: 192.168.1.100" required>
      </div>
      <div class="field">
        <label>Port:</label>
        <input type="number" id="configPort" value="{{ port or '6001' }}" required>
      </div>
      <button id="saveBtn" class="btn-send">ğŸ’¾ Kaydet ve Dinlemeyi BaÅŸlat</button>
      <p id="statusText" style="color: green; font-weight: bold; margin-top: 10px;"></p>
    </div>

    <!-- ğŸ“¤ Mesaj GÃ¶nder -->
    <div class="form-card">
      <h3>ğŸ“¤ Mesaj GÃ¶nder</h3>
      <div class="field">
        <label>Sunucu IP:</label>
        <input type="text" id="serverIP" placeholder="Ã¶rn: 192.168.1.170" required>
      </div>
      <div class="field">
        <label>Sunucu Port:</label>
        <input type="number" id="serverPort" value="6000" required>
      </div>

      <div class="field">
        <label>Åifreleme TÃ¼rÃ¼:</label>
        <select id="algorithmSelect" required>
          <option value="caesar">Sezar</option>
          <option value="vigenere">Vigenere</option>
          <option value="substitution">Substitution</option>
          <option value="affine">Affine</option>
        </select>
      </div>

      <div class="field">
        <label>Mesaj:</label>
        <input type="text" id="messageInput" placeholder="GÃ¶nderilecek metin..." required>
      </div>

      <button id="sendBtn" class="btn-send">ğŸ“¡ GÃ¶nder</button>
    </div>

    <!-- ğŸ”“ Gelen Mesajlar -->
    <div class="response-card">
      <h3>ğŸ”“ Sunucudan Gelen Mesajlar</h3>
      <div id="incomingBox" class="history-box"></div>
      <button id="clearBtn" class="btn-clear">ğŸ§¹ Temizle</button>
    </div>
  </div>

  <script>
    // === IP ve Port AyarlarÄ±nÄ± Kaydet ===
    document.getElementById("saveBtn").addEventListener("click", async () => {
      const ip = document.getElementById("configIP").value.trim();
      const port = document.getElementById("configPort").value.trim();
      const statusText = document.getElementById("statusText");

      if (!ip || !port) {
        alert("âš ï¸ LÃ¼tfen geÃ§erli bir IP ve port girin!");
        return;
      }

      const formData = new FormData();
      formData.append("ip", ip);
      formData.append("port", port);

      try {
        const res = await fetch("/update_config", {
          method: "POST",
          body: formData
        });
        const data = await res.json();

        if (data.status === "ok") {
          statusText.textContent = `âœ… Dinleme baÅŸlatÄ±ldÄ±: ${data.ip}:${data.port}`;
        } else {
          statusText.textContent = "âŒ Dinleme baÅŸlatÄ±lamadÄ±: " + (data.message || "");
          statusText.style.color = "red";
        }
      } catch (err) {
        statusText.textContent = "âŒ Flask backend'e ulaÅŸÄ±lamadÄ±!";
        statusText.style.color = "red";
      }
    });

    // === Mesaj GÃ¶nder ===
    document.getElementById("sendBtn").addEventListener("click", async () => {
      const ip = document.getElementById("serverIP").value.trim();
      const port = document.getElementById("serverPort").value.trim();
      const message = document.getElementById("messageInput").value.trim();
      const algorithm = document.getElementById("algorithmSelect").value;

      if (!ip || !port || !message) {
        alert("âš ï¸ TÃ¼m alanlarÄ± doldurun!");
        return;
      }

      const formData = new FormData();
      formData.append("ip", ip);
      formData.append("port", port);
      formData.append("message", message);
      formData.append("algorithm", algorithm);

      try {
        const res = await fetch("/send_message", {
          method: "POST",
          body: formData
        });
        const data = await res.json();

        if (data.success) {
          alert("âœ… Mesaj gÃ¶nderildi!\nSunucu cevabÄ±: " + data.response);
        } else {
          alert("âŒ GÃ¶nderim hatasÄ±: " + data.response);
        }
      } catch (err) {
        alert("âŒ BaÄŸlantÄ± kurulamadÄ±. Sunucu IP/Port kontrol edin.");
      }
    });

    // === Gelen MesajlarÄ± YÃ¼kle ===
    async function loadIncoming() {
      try {
        const res = await fetch("/incoming");
        const data = await res.json();
        const box = document.getElementById("incomingBox");
        box.innerHTML = "";
        data.forEach(msg => {
          const div = document.createElement("div");
          div.classList.add("message");
          div.textContent = msg;
          box.appendChild(div);
        });
      } catch (err) {
        console.warn("ğŸ” Mesaj yÃ¼klenemedi:", err);
      }
    }

    // === Temizle ===
    document.getElementById("clearBtn").addEventListener("click", async () => {
      await fetch("/clear", { method: "POST" });
      document.getElementById("incomingBox").innerHTML = "";
    });

    setInterval(loadIncoming, 2000);
  </script>
</body>
</html>
