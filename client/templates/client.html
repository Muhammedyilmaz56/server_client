<!DOCTYPE html>
<html lang="tr">

<head>
  <meta charset="UTF-8">
  <title>KriptoClient</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
</head>

<body>
  <div class="container">
    <h1>Kriptoloji Client Paneli</h1>

    <div class="form-card">
      <h3>IP & Port Ayarları</h3>
      <div class="field">
        <label>IP Adresi:</label>
        <input type="text" id="configIP" value="{{ ip or '' }}" placeholder="örn: 192.168.1.100">
      </div>
      <div class="field">
        <label>Port:</label>
        <input type="number" id="configPort" value="{{ port or '6001' }}">
      </div>
      <button id="saveBtn" class="btn-send">Kaydet ve Dinlemeyi Başlat</button>
      <p id="statusText" style="color:green;font-weight:bold;margin-top:10px;"></p>
    </div>

    <div class="form-card">
      <h3>RSA ile AES Oturum Anahtarı Kur</h3>
      <div class="field">
        <label>Server HTTP:</label>
        <input type="text" id="serverHttp" value="http://127.0.0.1:5000" placeholder="örn: http://127.0.0.1:5000">
      </div>
      <div class="field">
        <label>AES Şifre:</label>
        <input type="text" id="aesSessionPass" placeholder="örn: aespass123">
      </div>
      <button id="rsaSetupBtn" class="btn-send">RSA Kur</button>
      <p id="rsaStatusText" style="color:orange;font-weight:bold;margin-top:10px;"></p>
    </div>

    <div class="form-card">
      <h3>Mesaj Gönder</h3>
      <div class="field">
        <label>Sunucu IP:</label>
        <input type="text" id="serverIP" placeholder="örn: 192.168.1.170">
      </div>
      <div class="field">
        <label>Sunucu Port:</label>
        <input type="number" id="serverPort" value="6000">
      </div>
      <div class="field">
        <label>Şifreleme Türü:</label>
        <select id="algorithmSelect">
          <option value="" disabled selected>Lütfen algoritma seçin</option>
          <option value="caesar">Sezar</option>
          <option value="vigenere">Vigenere</option>
          <option value="substitution">Substitution</option>
          <option value="affine">Affine</option>
          <option value="playfair">Playfair</option>
          <option value="railfence">Rail Fence</option>
          <option value="route">Route Cipher</option>
          <option value="columnar">Columnar Cipher</option>
          <option value="polybius">Polybius Cipher</option>
          <option value="pigpen">Pigpen Cipher</option>
          <option value="hill">Hill Cipher</option>
          <option value="des">DES (Kütüphanesiz)</option>
          <option value="des_lib">DES (Kütüphaneli)</option>
          <option value="aes">AES-128 (Manuel)</option>
          <option value="aes_lib">AES-128 (Kütüphaneli)</option>
          <option value="aes_session">AES (RSA ile dağıtılan anahtar)</option>
        </select>
      </div>

      <div class="field" id="keyField" style="display:none;">
        <label id="keyLabel">Anahtar:</label>
        <input type="text" id="keyInput" placeholder="örnek: 3 veya anahtar veya 5,8">
      </div>

      <div class="field">
        <label>Mesaj:</label>
        <input type="text" id="messageInput" placeholder="Gönderilecek metin...">
      </div>
      <button id="sendBtn" class="btn-send">Gönder</button>
    </div>

    <div class="response-card">
      <h3>Sohbet Geçmişi</h3>
      <div id="chatBox" class="chat-box"></div>
      <button id="clearBtn" class="btn-clear">Temizle</button>
    </div>
  </div>

  <script>
    const socket = io();
    let rsaReady = false;

    function addMessage(msg) {
      const box = document.getElementById("chatBox");
      const div = document.createElement("div");
      div.classList.add("chat-message");

      if (msg.from === "client") div.classList.add("from-client");
      else div.classList.add("from-server");

      if (msg.algorithm === "pigpen") {
        const timeInfo = msg.encrypt_time ? `<br><b>Şifreleme Süresi:</b> ${msg.encrypt_time} sn` : (msg.decrypt_time ? `<br><b>Çözme Süresi:</b> ${msg.decrypt_time} sn` : '');
        div.innerHTML = `
          <div class="meta">
            <b>${msg.from === "client" ? "Client" : "Server"}</b>
            <small>(${msg.algorithm})</small>
          </div>
          <div class="bubble">
            <p><b>Şifreli:</b></p>
            <div>${msg.encrypted.split('|').filter(p => p && p.trim() !== "").map(p => p ? `<img src="${p}" width="40">` : '').join('')}</div>
            <p><b>Çözülmüş:</b> ${msg.decrypted}${timeInfo}</p>
          </div>
        `;
      } else {
        const timeInfo = msg.encrypt_time ? `<p><b>⏱ Şifreleme Süresi:</b> ${msg.encrypt_time} sn</p>` : (msg.decrypt_time ? `<p><b>⏱ Çözme Süresi:</b> ${msg.decrypt_time} sn</p>` : '');
        div.innerHTML = `
          <div class="meta">
            <b>${msg.from === "client" ? "Client" : "Server"}</b>
            <small>(${msg.algorithm})</small>
          </div>
          <div class="bubble">
            <p><b>Şifreli:</b> ${msg.encrypted}</p>
            <p><b>Çözülmüş:</b> ${msg.decrypted}</p>
            ${timeInfo}
          </div>
        `;
      }

      box.appendChild(div);
      box.scrollTop = box.scrollHeight;
    }

    socket.on("connect", () => console.log("SocketIO bağlantısı aktif"));
    socket.on("incoming_new", (msg) => addMessage(msg));
    socket.on("incoming_cleared", () => {
      document.getElementById("chatBox").innerHTML = "";
    });

    document.getElementById("saveBtn").onclick = async () => {
      const ip = document.getElementById("configIP").value.trim();
      const port = document.getElementById("configPort").value.trim();
      if (!ip || !port) return alert("IP ve port girin!");
      const form = new FormData();
      form.append("ip", ip);
      form.append("port", port);
      const res = await fetch("/update_config", { method: "POST", body: form });
      const data = await res.json();
      const text = document.getElementById("statusText");
      if (data.status === "ok") {
        text.textContent = `Dinleme aktif: ${data.ip}:${data.port}`;
        text.style.color = "green";
      } else {
        text.textContent = "Hata: " + data.message;
        text.style.color = "red";
      }
    };

    document.getElementById("rsaSetupBtn").onclick = async () => {
      const serverHttp = document.getElementById("serverHttp").value.trim();
      const aesPassword = document.getElementById("aesSessionPass").value.trim();
      const rsaText = document.getElementById("rsaStatusText");

      if (!serverHttp || !aesPassword) {
        rsaReady = false;
        rsaText.textContent = "Hata: Server HTTP ve AES Şifre boş olamaz!";
        rsaText.style.color = "red";
        return;
      }

      const form = new FormData();
      form.append("server_http", serverHttp);
      form.append("aes_password", aesPassword);

      const res = await fetch("/rsa/setup", { method: "POST", body: form });
      const data = await res.json();

      if (data.success) {
        rsaReady = true;
        rsaText.textContent = "RSA kuruldu. AES oturum anahtarı hazır.";
        rsaText.style.color = "green";
      } else {
        rsaReady = false;
        rsaText.textContent = "Hata: " + (data.error || "RSA setup başarısız");
        rsaText.style.color = "red";
      }
    };

    const algoSelect = document.getElementById("algorithmSelect");
    const keyField = document.getElementById("keyField");
    const keyLabel = document.getElementById("keyLabel");

    algoSelect.addEventListener("change", () => {
      const algo = algoSelect.value;

      if (algo === "caesar") {
        keyField.style.display = "block";
        keyLabel.textContent = "Anahtar (örn: 3)";
      } else if (algo === "vigenere") {
        keyField.style.display = "block";
        keyLabel.textContent = "Anahtar (örn: anahtar)";
      } else if (algo === "affine") {
        keyField.style.display = "block";
        keyLabel.textContent = "a,b Değerleri (örn: 5,8)";
      } else if (algo === "playfair") {
        keyField.style.display = "block";
        keyLabel.textContent = "Anahtar (örn: MONARCHY)";
      } else if (algo === "railfence") {
        keyField.style.display = "block";
        keyLabel.textContent = "Anahtar (satır sayısı, örn: 2)";
      } else if (algo === "route") {
        keyField.style.display = "block";
        keyLabel.textContent = "Sütun sayısı (örn: 5)";
      } else if (algo === "columnar") {
        keyField.style.display = "block";
        keyLabel.textContent = "Anahtar kelime (örn: TRUVA)";
      } else if (algo === "hill") {
        keyField.style.display = "block";
        keyLabel.textContent = "Hill anahtarı (4 sayı, örn: 3 3 2 5)";
      } else if (algo === "des" || algo === "des_lib") {
        keyField.style.display = "block";
        keyLabel.textContent = "DES Parolası (örn: despass1)";
      } else if (algo === "aes" || algo === "aes_lib") {
        keyField.style.display = "block";
        keyLabel.textContent = "AES Anahtarı (16 byte/parola, örn: aespass123)";
      } else if (algo === "aes_session") {
        keyField.style.display = "none";
      } else {
        keyField.style.display = "none";
      }
    });

    document.getElementById("sendBtn").onclick = async () => {
      const ip = document.getElementById("serverIP").value.trim();
      const port = document.getElementById("serverPort").value.trim();
      const msg = document.getElementById("messageInput").value.trim();
      const algo = document.getElementById("algorithmSelect").value;
      const key = document.getElementById("keyInput").value.trim();

      if (!ip || !port || !msg) return alert("Tüm alanları doldurun!");
      if (!algo) return alert("Algoritma seçin!");

      if (algo === "aes_session" && !rsaReady) {
        return alert("Önce RSA Kur ile AES oturum anahtarını kurmalısın.");
      }

      const form = new FormData();
      form.append("ip", ip);
      form.append("port", port);
      form.append("message", msg);
      form.append("algorithm", algo);
      if (key && algo !== "aes_session") form.append("key", key);

      const res = await fetch("/send_message", { method: "POST", body: form });
      const data = await res.json();

      if (!data.success) alert("Hata: " + data.response);
      else document.getElementById("messageInput").value = "";
    };

    document.getElementById("clearBtn").onclick = async () => {
      await fetch("/clear", { method: "POST" });
    };
  </script>
</body>

</html>