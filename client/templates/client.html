<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <title>ğŸ” KriptoClient</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
  <div class="container">
    <h1 class="title">ğŸ” Kriptoloji Ä°letiÅŸim Paneli</h1>

    <!-- ğŸŒ IP & Port AyarlarÄ± -->
    <div class="form-card">
      <h3>ğŸŒ IP & Port AyarlarÄ±</h3>
      <div class="field">
        <label>IP Adresi:</label>
        <input type="text" id="configIP" value="{{ ip or '' }}" placeholder="Ã¶rn: 192.168.1.10">
      </div>
      <div class="field">
        <label>Port:</label>
        <input type="number" id="configPort" value="{{ port or '6001' }}" placeholder="Ã¶rn: 6001">
      </div>
      <div class="btn-group">
        <button class="btn-send" onclick="updateConfig()">ğŸ’¾ Kaydet ve Dinlemeyi BaÅŸlat</button>
        <button class="btn-auto" onclick="autoDetectIP()">ğŸŒ IPâ€™mi Otomatik Bul</button>
      </div>
    </div>

    <!-- ğŸ“¤ Mesaj GÃ¶nderme Formu -->
    <div class="form-card">
      <form method="post">
        <div class="field">
          <label>Sunucu IP:</label>
          <input type="text" name="ip" id="serverIP" value="127.0.0.1" required>
        </div>

        <div class="field">
          <label>Port:</label>
          <input type="number" name="port" id="serverPort" value="6000" required>
        </div>

        <div class="field">
          <label>Åifreleme TÃ¼rÃ¼:</label>
          <select name="algorithm" id="algorithmSelect" required>
            <option value="caesar" {% if selected_algorithm == "caesar" %}selected{% endif %}>Sezar</option>
            <option value="vigenere" {% if selected_algorithm == "vigenere" %}selected{% endif %}>Vigenere</option>
            <option value="substitution" {% if selected_algorithm == "substitution" %}selected{% endif %}>Substitution</option>
            <option value="affine" {% if selected_algorithm == "affine" %}selected{% endif %}>Affine</option>
          </select>
        </div>

        <div id="extraFields"></div>

        <div class="field">
          <label>MesajÄ±nÄ±z:</label>
          <input type="text" name="message" placeholder="GÃ¶nderilecek metin..." required>
        </div>

        <button type="submit" class="btn-send">ğŸ“¡ GÃ¶nder</button>
      </form>
    </div>

    <!-- ğŸ”“ Sunucu YanÄ±tÄ± -->
    {% if response %}
      <div class="response-card">
        <h3>ğŸ”“ Sunucu YanÄ±tÄ±</h3>
        <p>{{ response }}</p>
      </div>
    {% endif %}

    <!-- ğŸ“¥ Gelen Mesajlar -->
    <div class="history-section">
      <div class="history-header">
        <h3>ğŸ“¥ Sunucudan Gelen Mesajlar</h3>
        <button id="clearBtn" class="btn-clear">ğŸ§¹ Temizle</button>
      </div>

      <div class="history-box" id="incomingBox"></div>
    </div>
  </div>

  <script>
    // === Åifreleme tÃ¼rÃ¼ne gÃ¶re ek alanlar ===
    const select = document.getElementById("algorithmSelect");
    const extraFields = document.getElementById("extraFields");
    const incomingBox = document.getElementById("incomingBox");

    function updateExtraFields() {
      const value = select.value;
      extraFields.innerHTML = "";
      if (value === "caesar") {
        extraFields.innerHTML = '<div class="field"><label>Shift:</label><input type="number" name="shift" value="3"></div>';
      } else if (value === "vigenere") {
        extraFields.innerHTML = '<div class="field"><label>Anahtar:</label><input type="text" name="key" value="anahtar"></div>';
      } else if (value === "affine") {
        extraFields.innerHTML = '<div class="field"><label>a:</label><input type="number" name="a" value="5"></div><div class="field"><label>b:</label><input type="number" name="b" value="8"></div>';
      } else if (value === "substitution") {
        extraFields.innerHTML = '<small class="note">ğŸ”’ Sabit Substitution anahtarÄ± kullanÄ±lacak.</small>';
      }
    }
    select.addEventListener("change", updateExtraFields);
    updateExtraFields();

    // === Mesaj geÃ§miÅŸini yÃ¼kle ===
    async function loadIncoming() {
      const res = await fetch("/incoming");
      const data = await res.json();
      incomingBox.innerHTML = "";
      data.slice(-10).forEach(msg => {
        const div = document.createElement("div");
        div.classList.add("message");
        div.textContent = msg;
        incomingBox.appendChild(div);
      });
    }

    // === GeÃ§miÅŸ temizleme ===
    async function clearMessages() {
      await fetch("/clear", { method: "POST" });
      incomingBox.innerHTML = "";
    }

    // === IP/Port kaydet ===
    async function updateConfig() {
      const ip = document.getElementById("configIP").value;
      const port = document.getElementById("configPort").value;

      if (!ip || !port) {
        alert("âš ï¸ LÃ¼tfen geÃ§erli bir IP ve Port girin!");
        return;
      }

      const formData = new FormData();
      formData.append("ip", ip);
      formData.append("port", port);

      const res = await fetch("/update_config", { method: "POST", body: formData });
      const data = await res.json();
      alert(`âœ… Dinleme ayarlarÄ± gÃ¼ncellendi:\n${data.ip}:${data.port}`);
    }

    // === IP otomatik algÄ±lama ===
    async function autoDetectIP() {
      const res = await fetch("https://api.ipify.org?format=json");
      const data = await res.json();
      document.getElementById("configIP").value = data.ip;
      alert(`ğŸŒ IP adresiniz algÄ±landÄ±: ${data.ip}`);
    }

    document.getElementById("clearBtn").addEventListener("click", clearMessages);
    setInterval(loadIncoming, 2000);
    loadIncoming();
  </script>
</body>
</html>
